# إعداد قاعدة البيانات Railway

## معلومات الاتصال

تستخدم المنصة قاعدة بيانات MySQL المستضافة على Railway.

### رابط الاتصال

```
mysql://USER:PASSWORD@HOST:PORT/DATABASE
```

⚠️ **ملاحظة أمنية**: احصل على بيانات الاتصال من لوحة تحكم Railway الخاصة بك.

### تفاصيل الاتصال

احصل على هذه المعلومات من Railway Dashboard:

- **المضيف (Host)**: يتم توفيره من Railway
- **المنفذ (Port)**: يتم توفيره من Railway
- **المستخدم (User)**: عادةً root
- **كلمة المرور (Password)**: يتم توليدها تلقائياً من Railway
- **قاعدة البيانات (Database)**: عادةً railway

## خطوات الإعداد

### 1. تكوين ملف البيئة

أنشئ ملف `.env` من نسخة المثال:

```bash
cp .env.example .env
```

ثم حدّث `DATABASE_URL` برابط الاتصال الخاص بك من Railway:

```bash
DATABASE_URL=mysql://USER:PASSWORD@HOST:PORT/railway
```

احصل على بيانات الاتصال من لوحة تحكم Railway → قاعدة البيانات → Connect

### 2. تطبيق Schema على قاعدة البيانات

```bash
# توليد ملفات الهجرة (Migrations)
pnpm drizzle-kit generate

# تطبيق الهجرة على قاعدة البيانات
pnpm drizzle-kit migrate
```

أو استخدام الأمر المختصر:

```bash
pnpm db:push
```

### 3. التحقق من الاتصال

يمكنك التحقق من الاتصال بقاعدة البيانات عند تشغيل السيرفر:

```bash
pnpm dev
```

ستظهر رسالة: `[Database] Connected successfully to Railway database`

## التحسينات المطبقة

### 1. إعادة المحاولة التلقائية

- يحاول النظام الاتصال بقاعدة البيانات حتى 3 مرات في حالة الفشل
- تأخير متزايد بين كل محاولة (1، 2، 3 ثوانٍ)

### 2. معالجة الأخطاء

- تسجيل تفصيلي للأخطاء في console
- رسائل خطأ واضحة للمستخدم
- عدم تعطل التطبيق في حالة فشل الاتصال

### 3. توليد معرفات فريدة

- استخدام `nanoid` لتوليد أرقام الحجز
- ضمان عدم التكرار حتى في حالة الطلبات المتزامنة

### 4. التحقق من صحة البيانات

- التحقق من صحة التقييمات (1-5)
- التحقق من وجود البيانات المطلوبة

## استعلامات مفيدة

### عرض جميع الجداول

```sql
SHOW TABLES;
```

### عرض بنية جدول معين

```sql
DESCRIBE table_name;
```

### عدد السجلات في جدول

```sql
SELECT COUNT(*) FROM table_name;
```

## استكشاف الأخطاء

### خطأ: "Cannot connect to database"

- تأكد من صحة رابط الاتصال
- تحقق من أن قاعدة البيانات نشطة على Railway
- تأكد من عدم وجود جدار ناري يمنع الاتصال

### خطأ: "Table doesn't exist"

- قم بتشغيل `pnpm db:push` لإنشاء الجداول

### خطأ: "Access denied"

- تحقق من صحة اسم المستخدم وكلمة المرور

## ملاحظات أمنية

⚠️ **هام**:

- لا تشارك رابط الاتصال في أماكن عامة
- لا ترفع ملف `.env` إلى GitHub
- غيّر كلمة المرور بشكل دوري
- استخدم SSL للاتصال في الإنتاج

## الدعم

في حالة وجود مشاكل، راجع:

1. لوحة تحكم Railway للتأكد من أن قاعدة البيانات تعمل
2. سجلات التطبيق (Application Logs)
3. سجلات قاعدة البيانات (Database Logs)
